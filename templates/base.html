<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Peer lens{% endblock %}</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #f8f9fa;
        }
        
        body {
            background-color: var(--light-bg);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--secondary-color) 0%, #2980b9 100%);
            border: none;
            border-radius: 25px;
            padding: 10px 30px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        
        .error-highlight {
            background-color: rgba(231, 76, 60, 0.1);
            border-left: 4px solid var(--danger-color);
            padding: 2px 5px;
            margin: 2px 0;
            border-radius: 3px;
        }
        
        .error-badge {
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 15px;
            margin-left: 5px;
        }
        
        .error-high { background-color: var(--danger-color); }
        .error-medium { background-color: var(--warning-color); }
        .error-low { background-color: #95a5a6; }
        
        .statistics-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .upload-area {
            border: 2px dashed var(--secondary-color);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: var(--primary-color);
            background-color: rgba(52, 152, 219, 0.05);
        }
        
        .upload-area.dragover {
            border-color: var(--success-color);
            background-color: rgba(39, 174, 96, 0.1);
        }
        
        .analysis-container {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .rewrite-suggestion {
            background-color: rgba(39, 174, 96, 0.1);
            border: 1px solid var(--success-color);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .spinner-custom {
            width: 2rem;
            height: 2rem;
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .floating-action {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
        }
        
        .progress-custom {
            height: 8px;
            border-radius: 10px;
            background-color: rgba(255,255,255,0.2);
        }
        
        .progress-bar-custom {
            background: linear-gradient(90deg, var(--success-color) 0%, #2ecc71 100%);
            border-radius: 10px;
        }
        
        /* Progress Steps Styling */
        .progress-steps {
            position: relative;
        }
        
        .step-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 1.5rem;
            padding: 1rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .step-item:not(:last-child)::after {
            content: '';
            position: absolute;
            left: 23px;
            top: 60px;
            width: 2px;
            height: calc(100% - 20px);
            background: #e9ecef;
            z-index: 1;
        }
        
        .step-item.active {
            background: rgba(13, 110, 253, 0.05);
            border: 1px solid rgba(13, 110, 253, 0.2);
        }
        
        .step-item.completed {
            background: rgba(25, 135, 84, 0.05);
            border: 1px solid rgba(25, 135, 84, 0.2);
        }
        
        .step-item.completed::after {
            background: #198754;
        }
        
        .step-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            flex-shrink: 0;
            background: white;
            border: 2px solid #e9ecef;
            position: relative;
            z-index: 2;
        }
        
        .step-item.active .step-icon {
            border-color: #0d6efd;
            background: white;
        }
        
        .step-item.completed .step-icon {
            border-color: #198754;
            background: #198754;
        }
        
        .step-content {
            flex: 1;
            min-width: 0;
        }
        
        .step-title {
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #495057;
        }
        
        .step-item.active .step-title {
            color: #0d6efd;
        }
        
        .step-item.completed .step-title {
            color: #198754;
        }
        
        .step-description {
            margin-bottom: 0;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        /* Animated pulse for active step */
        .step-item.active .step-icon {
            animation: pulse-border 2s infinite;
        }
        
        @keyframes pulse-border {
            0% {
                box-shadow: 0 0 0 0 rgba(13, 110, 253, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(13, 110, 253, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(13, 110, 253, 0);
            }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Success completion animation */
        .completion-success {
            animation: successPulse 0.6s ease-out;
        }
        
        @keyframes successPulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(25, 135, 84, 0.7);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(25, 135, 84, 0);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(25, 135, 84, 0);
            }
        }
    </style>
    
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <i class="fas fa-pen-fancy me-2"></i>
                Peer lens
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('index') }}">
                            <i class="fas fa-upload me-1"></i> Analyze
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('health_check') }}">
                            <i class="fas fa-heartbeat me-1"></i> Health
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container my-5">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                        <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'info-circle' }} me-2"></i>
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="bg-dark text-light text-center py-4 mt-5">
        <div class="container">
            <p class="mb-0">
                <i class="fas fa-code me-2"></i>
                Peer lens - Powered by AI
            </p>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <!-- Custom JavaScript -->
    <script>
        // Global variables
        let currentAnalysis = null;
        let currentContent = null;
        let socket = null;
        let sessionId = null;

        // Initialize Socket.IO connection
        function initializeSocket() {
            socket = io();
            
            socket.on('connect', function() {
                console.log('Connected to server');
            });
            
            socket.on('session_id', function(data) {
                sessionId = data.session_id;
                console.log('Session ID received:', sessionId);
            });
            
            socket.on('progress_update', function(data) {
                handleProgressUpdate(data);
            });
            
            socket.on('process_complete', function(data) {
                handleProcessComplete(data);
            });
            
            socket.on('disconnect', function() {
                console.log('Disconnected from server');
            });
        }

        // Handle real-time progress updates
        function handleProgressUpdate(data) {
            console.log('Progress update:', data);
            
            const statusElement = document.getElementById('current-status');
            const detailElement = document.getElementById('status-detail');
            
            if (statusElement && detailElement) {
                statusElement.textContent = data.status;
                detailElement.textContent = data.detail;
            }
            
            // Update step indicators based on actual progress
            updateStepIndicators(data.step, data.progress);
        }

        // Update step indicators based on real progress
        function updateStepIndicators(currentStep, progress) {
            const stepMapping = {
                'analysis_start': 'step-analysis',
                'spacy_processing': 'step-analysis',
                'metrics_calculation': 'step-analysis',
                'analysis_complete': 'step-analysis',
                'rewrite_start': 'step-analysis',
                'pass1_start': 'step-pass1',
                'pass1_processing': 'step-pass1',
                'pass1_complete': 'step-pass1',
                'pass2_start': 'step-pass2',
                'pass2_processing': 'step-pass2',
                'validation': 'step-complete',
                'rewrite_complete': 'step-complete'
            };
            
            const targetStepId = stepMapping[currentStep];
            if (!targetStepId) return;
            
            // Mark previous steps as complete
            const allSteps = document.querySelectorAll('.step-item');
            let foundTarget = false;
            
            allSteps.forEach((step) => {
                const stepId = step.id;
                
                if (stepId === targetStepId) {
                    foundTarget = true;
                    // Mark current step as active
                    step.classList.remove('completed');
                    step.classList.add('active');
                    const icon = step.querySelector('.step-icon');
                    if (currentStep.includes('complete')) {
                        // Step is complete
                        step.classList.remove('active');
                        step.classList.add('completed');
                        icon.innerHTML = '<i class="fas fa-check-circle text-success"></i>';
                    } else {
                        // Step is in progress
                        icon.innerHTML = '<div class="spinner-border spinner-border-sm text-primary" role="status"></div>';
                    }
                } else if (!foundTarget) {
                    // Mark previous steps as complete
                    step.classList.remove('active');
                    step.classList.add('completed');
                    const icon = step.querySelector('.step-icon');
                    icon.innerHTML = '<i class="fas fa-check-circle text-success"></i>';
                } else {
                    // Mark future steps as pending
                    step.classList.remove('active', 'completed');
                    const icon = step.querySelector('.step-icon');
                    icon.innerHTML = '<i class="fas fa-circle text-muted"></i>';
                }
            });
        }

        // Handle process completion
        function handleProcessComplete(data) {
            console.log('Process complete:', data);
            
            if (data.success && data.data) {
                // Display results based on the type of process
                if (data.data.analysis) {
                    // Analysis completed
                    currentAnalysis = data.data.analysis;
                    displayAnalysisResults(data.data.analysis, currentContent);
                } else if (data.data.rewritten_text) {
                    // Rewrite completed
                    displayRewriteResults(data.data);
                }
            } else {
                // Show error
                showError('analysis-results', data.error || 'Process failed');
            }
        }

        // Initialize socket connection when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            
            // Initialize tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });

        // Utility functions
        function showLoading(elementId, message = 'Processing...') {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-search me-2"></i>Analyzing Your Text
                                <span class="badge bg-primary ms-2">In Progress</span>
                            </h5>
                        </div>
                        <div class="card-body text-center">
                            <div class="mb-4">
                                <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <h6 class="text-primary">${message}</h6>
                            </div>
                            
                            <div class="row text-start">
                                <div class="col-md-6">
                                    <h6><i class="fas fa-check-circle text-success me-2"></i>What We're Analyzing:</h6>
                                    <ul class="list-unstyled small text-muted">
                                        <li><i class="fas fa-arrow-right me-2"></i>Sentence length and complexity</li>
                                        <li><i class="fas fa-arrow-right me-2"></i>Passive voice usage</li>
                                        <li><i class="fas fa-arrow-right me-2"></i>Wordy phrases and redundancy</li>
                                        <li><i class="fas fa-arrow-right me-2"></i>Readability scores (Flesch, Fog, etc.)</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6><i class="fas fa-chart-line text-info me-2"></i>Metrics Calculated:</h6>
                                    <ul class="list-unstyled small text-muted">
                                        <li><i class="fas fa-arrow-right me-2"></i>Grade level assessment</li>
                                        <li><i class="fas fa-arrow-right me-2"></i>Technical writing quality</li>
                                        <li><i class="fas fa-arrow-right me-2"></i>Word complexity analysis</li>
                                        <li><i class="fas fa-arrow-right me-2"></i>Overall improvement score</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="alert alert-info mt-3">
                                <small>
                                    <i class="fas fa-lightbulb me-2"></i>
                                    <strong>Tip:</strong> Analysis typically takes 2-5 seconds. We use SpaCy NLP for precise style detection.
                                </small>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${message}
                    </div>
                `;
            }
        }

        function showSuccess(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        ${message}
                    </div>
                `;
            }
        }

        // File upload handling
        function handleFileUpload(file) {
            const formData = new FormData();
            formData.append('file', file);

            showFileUploadProgress('analysis-results', file);

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentContent = data.content;
                    analyzeContent(data.content);
                } else {
                    showError('analysis-results', data.error || 'Upload failed');
                }
            })
            .catch(error => {
                console.error('Upload error:', error);
                showError('analysis-results', 'Upload failed: ' + error.message);
            });
        }

        // Show file upload progress
        function showFileUploadProgress(elementId, file) {
            const element = document.getElementById(elementId);
            if (element) {
                const fileSize = (file.size / 1024).toFixed(1);
                const fileType = file.type || 'Unknown';
                
                element.innerHTML = `
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-upload me-2"></i>Processing Document
                                <span class="badge bg-info ms-2">Uploading</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="text-center mb-4">
                                <div class="spinner-border text-info mb-3" role="status" style="width: 3rem; height: 3rem;">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <h6 class="text-info">Extracting text from your document...</h6>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i class="fas fa-file me-2 text-primary"></i>File Information:</h6>
                                    <ul class="list-unstyled small">
                                        <li><strong>Name:</strong> ${file.name}</li>
                                        <li><strong>Size:</strong> ${fileSize} KB</li>
                                        <li><strong>Type:</strong> ${fileType}</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6><i class="fas fa-cogs me-2 text-success"></i>Processing Steps:</h6>
                                    <ul class="list-unstyled small text-muted">
                                        <li><i class="fas fa-check text-success me-2"></i>File validation</li>
                                        <li><i class="fas fa-spinner fa-spin text-info me-2"></i>Text extraction</li>
                                        <li><i class="fas fa-circle text-muted me-2"></i>Content analysis</li>
                                        <li><i class="fas fa-circle text-muted me-2"></i>Results display</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="alert alert-info mt-3">
                                <small>
                                    <i class="fas fa-shield-alt me-2"></i>
                                    <strong>Privacy:</strong> Your document is processed locally and never stored on our servers.
                                </small>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Content analysis
        function analyzeContent(content) {
            showLoading('analysis-results', 'Starting analysis...');

            fetch('/analyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    content: content,
                    session_id: sessionId 
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentAnalysis = data.analysis;
                    displayAnalysisResults(data.analysis, content);
                } else {
                    showError('analysis-results', data.error || 'Analysis failed');
                }
            })
            .catch(error => {
                console.error('Analysis error:', error);
                showError('analysis-results', 'Analysis failed: ' + error.message);
            });
        }

        // Display analysis results
        function displayAnalysisResults(analysis, content) {
            const resultsContainer = document.getElementById('analysis-results');
            
            let html = `
                <div class="row">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i>Content Analysis</h5>
                                <span class="badge ${analysis.overall_score >= 80 ? 'bg-success' : analysis.overall_score >= 60 ? 'bg-warning' : 'bg-danger'}">
                                    Score: ${analysis.overall_score.toFixed(1)}%
                                </span>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <h6>Original Content:</h6>
                                    <div class="border rounded p-3 bg-light">
                                        ${highlightErrors(content, analysis.errors)}
                                    </div>
                                </div>
                                
                                ${analysis.errors.length > 0 ? `
                                <div class="mb-3">
                                    <h6>Detected Issues (${analysis.errors.length}):</h6>
                                    <div class="analysis-container">
                                        ${analysis.errors.map(error => createErrorCard(error)).join('')}
                                    </div>
                                </div>
                                ` : '<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>No issues detected!</div>'}
                                
                                ${analysis.errors.length > 0 ? `
                                <div class="text-center">
                                    <button class="btn btn-primary btn-lg" onclick="rewriteContent()">
                                        <i class="fas fa-magic me-2"></i>Rewrite with AI
                                    </button>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <!-- Ultra-Modern Technical Writing Statistics Card -->
                        <div class="card border-0 shadow-lg" style="border-radius: 24px; overflow: hidden; background: white;">
                            <!-- Modern gradient header -->
                            <div class="card-header border-0 pb-2" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #06b6d4 100%); color: white; border-radius: 0;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0 fw-bold">
                                        <i class="fas fa-chart-line me-2"></i>Writing Analytics
                                    </h5>
                                    <button class="btn btn-sm btn-light btn-outline-light rounded-pill opacity-90" data-bs-toggle="modal" data-bs-target="#metricsHelpModal" style="border: 1px solid rgba(255,255,255,0.3);">
                                        <i class="fas fa-question-circle"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body pt-3" style="color: #2d3748; background: white;">
                                
                                <!-- Grade Level Assessment - Hero Section -->
                                <div class="text-center mb-4 p-4 rounded-4" style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border: 2px solid #e2e8f0;">
                                    <div class="d-flex justify-content-center align-items-center mb-3">
                                        <div class="me-4">
                                            <h1 class="mb-1 fw-bold" style="color: ${analysis.technical_writing_metrics?.meets_target_grade ? '#059669' : '#d97706'}; font-size: 2.5rem;">
                                                ${analysis.technical_writing_metrics?.estimated_grade_level?.toFixed(1) || 'N/A'}
                                            </h1>
                                            <small class="text-muted fw-medium">Grade Level</small>
                                        </div>
                                        <div class="text-start">
                                            <div class="badge fs-6 mb-2" style="background: ${analysis.technical_writing_metrics?.meets_target_grade ? 'linear-gradient(135deg, #10b981, #059669)' : 'linear-gradient(135deg, #f59e0b, #d97706)'}; color: white; padding: 8px 16px;">
                                                ${analysis.technical_writing_metrics?.grade_level_category || 'Unknown'}
                                            </div>
                                            <div class="small d-flex align-items-center">
                                                ${analysis.technical_writing_metrics?.meets_target_grade ? 
                                                    '<i class="fas fa-check-circle me-2" style="color: #059669;"></i><span style="color: #059669;">Perfect for technical docs</span>' : 
                                                    '<i class="fas fa-exclamation-triangle me-2" style="color: #d97706;"></i><span style="color: #d97706;">Outside target (9-11th grade)</span>'
                                                }
                                            </div>
                                        </div>
                                    </div>
                                    <div class="small text-muted p-3 rounded-3" style="background: white; border: 1px solid #e2e8f0;">
                                        ${getGradeLevelInsight(analysis.technical_writing_metrics?.estimated_grade_level, analysis.technical_writing_metrics?.meets_target_grade)}
                                    </div>
                                </div>

                                <!-- Document Overview - Clean Modern Cards -->
                                <div class="row g-3 mb-4">
                                    <div class="col-4">
                                        <div class="text-center p-3 rounded-3" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);">
                                            <h3 class="mb-1 fw-bold">${analysis.statistics.word_count || 0}</h3>
                                            <small class="fw-medium">Words</small>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="text-center p-3 rounded-3" style="background: linear-gradient(135deg, #06b6d4, #0891b2); color: white; box-shadow: 0 4px 12px rgba(6, 182, 212, 0.25);">
                                            <h3 class="mb-1 fw-bold">${analysis.statistics.sentence_count || 0}</h3>
                                            <small class="fw-medium">Sentences</small>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="text-center p-3 rounded-3" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.25);">
                                            <h3 class="mb-1 fw-bold">${Math.ceil((analysis.statistics.word_count || 0) / 250)}</h3>
                                            <small class="fw-medium">Pages</small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Readability Scores - Light Modern Cards -->
                                <div class="mb-4">
                                    <h6 class="text-center mb-3 fw-semibold d-flex align-items-center justify-content-center" style="color: #374151;">
                                        <i class="fas fa-tachometer-alt me-2" style="color: #6366f1;"></i>Readability Metrics
                                    </h6>
                                    <div class="row g-2">
                                        ${generateModernReadabilityCard('Flesch Score', analysis.statistics.flesch_reading_ease, 'Higher = easier to read', 'fas fa-book-open', getFleschColor(analysis.statistics.flesch_reading_ease))}
                                        ${generateModernReadabilityCard('Fog Index', analysis.statistics.gunning_fog_index, 'Education years needed', 'fas fa-graduation-cap', getFogColor(analysis.statistics.gunning_fog_index))}
                                        ${generateModernReadabilityCard('SMOG Grade', analysis.statistics.smog_index, 'School grade level', 'fas fa-school', getGradeColor(analysis.statistics.smog_index))}
                                        ${generateModernReadabilityCard('ARI Score', analysis.statistics.automated_readability_index, 'Age to understand', 'fas fa-user-graduate', getGradeColor(analysis.statistics.automated_readability_index))}
                                    </div>
                                </div>

                                <!-- Writing Quality - Light Background Progress Bars -->
                                <div class="mb-4">
                                    <h6 class="text-center mb-3 fw-semibold d-flex align-items-center justify-content-center" style="color: #374151;">
                                        <i class="fas fa-clipboard-check me-2" style="color: #059669;"></i>Writing Quality
                                    </h6>
                                    
                                    <!-- Modern Passive Voice Indicator -->
                                    <div class="mb-3 p-3 rounded-3" style="background: rgba(59, 130, 246, 0.05); border: 1px solid rgba(59, 130, 246, 0.1);">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-exchange-alt me-2" style="color: #3b82f6;"></i>
                                                <span class="fw-medium" style="color: #1f2937;">Passive Voice</span>
                                                <span class="badge bg-light text-dark ms-2 rounded-pill" data-bs-toggle="tooltip" title="Keep under 15% for active writing" style="font-size: 0.7rem;">?</span>
                                            </div>
                                            <span class="fw-bold" style="color: #1f2937;">${(analysis.statistics.passive_voice_percentage || 0).toFixed(1)}%</span>
                                        </div>
                                        <div class="progress mb-2" style="height: 8px; background: rgba(59, 130, 246, 0.1); border-radius: 10px;">
                                            <div class="progress-bar" 
                                                 style="width: ${Math.min(100, (analysis.statistics.passive_voice_percentage || 0) * 6.67)}%; border-radius: 10px; background: ${getModernPassiveVoiceGradient(analysis.statistics.passive_voice_percentage)};"></div>
                                        </div>
                                        <div class="small" style="color: #6b7280;">
                                            ${getPassiveVoiceInsight(analysis.statistics.passive_voice_percentage)}
                                        </div>
                                    </div>

                                    <!-- Modern Sentence Length Indicator -->
                                    <div class="mb-3 p-3 rounded-3" style="background: rgba(6, 182, 212, 0.05); border: 1px solid rgba(6, 182, 212, 0.1);">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-text-width me-2" style="color: #06b6d4;"></i>
                                                <span class="fw-medium" style="color: #1f2937;">Sentence Length</span>
                                                <span class="badge bg-light text-dark ms-2 rounded-pill" data-bs-toggle="tooltip" title="Aim for 15-20 words per sentence" style="font-size: 0.7rem;">?</span>
                                            </div>
                                            <span class="fw-bold" style="color: #1f2937;">${(analysis.statistics.avg_sentence_length || 0).toFixed(1)} words</span>
                                        </div>
                                        <div class="progress mb-2" style="height: 8px; background: rgba(6, 182, 212, 0.1); border-radius: 10px;">
                                            <div class="progress-bar" 
                                                 style="width: ${Math.min(100, (analysis.statistics.avg_sentence_length || 0) * 2.5)}%; border-radius: 10px; background: ${getModernSentenceLengthGradient(analysis.statistics.avg_sentence_length)};"></div>
                                        </div>
                                        <div class="small" style="color: #6b7280;">
                                            ${getSentenceLengthInsight(analysis.statistics.avg_sentence_length)}
                                        </div>
                                    </div>

                                    <!-- Modern Word Complexity Indicator -->
                                    <div class="mb-3 p-3 rounded-3" style="background: rgba(139, 92, 246, 0.05); border: 1px solid rgba(139, 92, 246, 0.1);">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-brain me-2" style="color: #8b5cf6;"></i>
                                                <span class="fw-medium" style="color: #1f2937;">Complex Words</span>
                                                <span class="badge bg-light text-dark ms-2 rounded-pill" data-bs-toggle="tooltip" title="Words with 3+ syllables" style="font-size: 0.7rem;">?</span>
                                            </div>
                                            <span class="fw-bold" style="color: #1f2937;">${(analysis.statistics.complex_words_percentage || 0).toFixed(1)}%</span>
                                        </div>
                                        <div class="progress mb-2" style="height: 8px; background: rgba(139, 92, 246, 0.1); border-radius: 10px;">
                                            <div class="progress-bar" 
                                                 style="width: ${Math.min(100, (analysis.statistics.complex_words_percentage || 0) * 3.33)}%; border-radius: 10px; background: ${getModernComplexWordsGradient(analysis.statistics.complex_words_percentage)};"></div>
                                        </div>
                                        <div class="small" style="color: #6b7280;">
                                            ${getComplexWordsInsight(analysis.statistics.complex_words_percentage)}
                                        </div>
                                    </div>
                                </div>

                                <!-- Smart Recommendations - Clean Modern Design -->
                                <div class="mt-4">
                                    <h6 class="text-center mb-3 fw-semibold d-flex align-items-center justify-content-center" style="color: #374151;">
                                        <i class="fas fa-lightbulb me-2" style="color: #f59e0b;"></i>Smart Recommendations
                                    </h6>
                                    <div class="smart-recommendations">
                                        ${generateModernSmartRecommendations(analysis)}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            resultsContainer.innerHTML = html;
        }

        // Create error card HTML
        function createErrorCard(error) {
            const severityClass = `error-${error.severity || 'medium'}`;
            const icon = {
                'sentence_length': 'fas fa-text-width',
                'passive_voice': 'fas fa-exchange-alt',
                'conciseness': 'fas fa-compress-alt',
                'clarity': 'fas fa-eye',
                'readability': 'fas fa-book-open',
                'grammar': 'fas fa-spell-check'
            }[error.type] || 'fas fa-exclamation-triangle';

            return `
                <div class="card mb-2">
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="card-title mb-1">
                                    <i class="${icon} me-2"></i>
                                    ${error.type.replace('_', ' ').toUpperCase()}
                                    <span class="badge ${severityClass} error-badge">${error.severity || 'medium'}</span>
                                </h6>
                                <p class="card-text mb-1">${error.message}</p>
                                ${error.suggestions && error.suggestions.length > 0 ? `
                                    <small class="text-muted">
                                        <strong>Suggestions:</strong> ${error.suggestions.join(', ')}
                                    </small>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Highlight errors in content
        function highlightErrors(content, errors) {
            let highlightedContent = content;
            
            errors.forEach(error => {
                if (error.sentence) {
                    const regex = new RegExp(escapeRegex(error.sentence), 'gi');
                    highlightedContent = highlightedContent.replace(regex, 
                        `<span class="error-highlight" title="${error.message}">${error.sentence}</span>`
                    );
                }
            });
            
            return highlightedContent;
        }

        // Escape regex special characters
        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // AI Rewrite functionality (Pass 1)
        function rewriteContent() {
            if (!currentContent || !currentAnalysis) {
                alert('No content to rewrite');
                return;
            }

            showRewriteProgress('rewrite-results', 'Starting AI Pass 1...');

            fetch('/rewrite', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    content: currentContent,
                    errors: currentAnalysis.errors,
                    context: 'paragraph',
                    session_id: sessionId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayPass1Results(data);
                } else {
                    showError('rewrite-results', data.error || 'Rewrite failed');
                }
            })
            .catch(error => {
                console.error('Rewrite error:', error);
                showError('rewrite-results', 'Rewrite failed: ' + error.message);
            });
        }

        // AI Refinement functionality (Pass 2)
        function refineContent(firstPassResult, originalErrors) {
            showRefinementProgress('rewrite-results', 'Starting AI Pass 2...');

            fetch('/refine', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    first_pass_result: firstPassResult,
                    original_errors: originalErrors,
                    context: 'paragraph',
                    session_id: sessionId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayPass2Results(data, firstPassResult, originalErrors);
                } else {
                    showError('rewrite-results', data.error || 'Refinement failed');
                }
            })
            .catch(error => {
                console.error('Refinement error:', error);
                showError('rewrite-results', 'Refinement failed: ' + error.message);
            });
        }

        // Show Pass 1 progress
        function showRewriteProgress(elementId, initialMessage) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-cogs me-2"></i>AI Pass 1: Initial Rewrite
                                <span class="badge bg-info ms-2">In Progress</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info mb-4">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Pass 1:</strong> AI is addressing the detected style issues to create an improved version.
                            </div>
                            
                            <!-- Current Status -->
                            <div class="p-3 bg-light rounded">
                                <div class="d-flex align-items-center">
                                    <div class="spinner-border spinner-border-sm text-primary me-3" role="status"></div>
                                    <div>
                                        <strong>Current Status:</strong> <span id="current-status">${initialMessage}</span>
                                        <br>
                                        <small class="text-muted" id="status-detail">Processing ${currentAnalysis.errors.length} detected issues...</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Show Pass 2 progress
        function showRefinementProgress(elementId, initialMessage) {
            const element = document.getElementById(elementId);
            if (element) {
                // Find the existing Pass 1 results and add Pass 2 progress
                const existingContent = element.innerHTML;
                element.innerHTML = existingContent + `
                    <div class="card mt-4" id="pass2-progress">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-sparkles me-2"></i>AI Pass 2: Refinement & Polish
                                <span class="badge bg-warning ms-2">In Progress</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-warning mb-4">
                                <i class="fas fa-magic me-2"></i>
                                <strong>Pass 2:</strong> AI is now reviewing and polishing its own work for maximum quality.
                            </div>
                            
                            <!-- Current Status -->
                            <div class="p-3 bg-light rounded">
                                <div class="d-flex align-items-center">
                                    <div class="spinner-border spinner-border-sm text-warning me-3" role="status"></div>
                                    <div>
                                        <strong>Current Status:</strong> <span id="refine-status">${initialMessage}</span>
                                        <br>
                                        <small class="text-muted" id="refine-detail">AI critically reviewing its own output...</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Display Pass 1 results with option for Pass 2
        function displayPass1Results(data) {
            const resultsContainer = document.getElementById('rewrite-results');
            
            let html = `
                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-edit me-2"></i>AI Pass 1 Results
                            <span class="badge bg-success ms-2">Completed</span>
                            <span class="badge bg-info ms-2">Confidence: ${(data.confidence * 100).toFixed(1)}%</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-success mb-4">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Pass 1 Complete!</strong> AI has addressed the detected style issues. You can use this result or refine it further with Pass 2.
                        </div>
                        
                        <!-- Two-column comparison -->
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-file-alt me-2"></i>Original:</h6>
                                <div class="border rounded p-3 bg-light mb-3" style="max-height: 200px; overflow-y: auto;">
                                    ${data.original}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-edit me-2 text-success"></i>Pass 1 - Improved:</h6>
                                <div class="border rounded p-3 bg-success bg-opacity-10 mb-3" style="max-height: 200px; overflow-y: auto;">
                                    ${data.rewritten_text}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Improvements -->
                        <div class="mb-4">
                            <h6><i class="fas fa-list-check me-2"></i>Pass 1 Improvements:</h6>
                            <ul class="list-group list-group-flush">
                                ${data.improvements.map(improvement => `
                                    <li class="list-group-item border-0 px-0">
                                        <i class="fas fa-check text-success me-2"></i>
                                        ${improvement}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                        
                        <!-- Action buttons -->
                        <div class="text-center">
                            <button class="btn btn-outline-primary me-2" onclick="copyToClipboard('${data.rewritten_text.replace(/'/g, "\\'")}')">
                                <i class="fas fa-copy me-2"></i>Use This Result
                            </button>
                            <button class="btn btn-outline-secondary me-2" onclick="analyzeContent('${data.rewritten_text.replace(/'/g, "\\'")}')">
                                <i class="fas fa-redo me-2"></i>Re-analyze
                            </button>
                            ${data.can_refine ? `
                            <button class="btn btn-warning" onclick="refineContent('${data.rewritten_text.replace(/'/g, "\\'")}', ${JSON.stringify(data.original_errors).replace(/"/g, '&quot;')})">
                                <i class="fas fa-sparkles me-2"></i>Refine Further (Pass 2)
                            </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            resultsContainer.innerHTML = html;
        }

        // Display Pass 2 results
        function displayPass2Results(data, firstPassResult, originalErrors) {
            // Remove the progress indicator
            const progressElement = document.getElementById('pass2-progress');
            if (progressElement) {
                progressElement.remove();
            }
            
            const resultsContainer = document.getElementById('rewrite-results');
            
            let html = `
                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-sparkles me-2"></i>AI Pass 2 Results - Final Polish
                            <span class="badge bg-success ms-2">Completed</span>
                            <span class="badge bg-warning ms-2">Confidence: ${(data.confidence * 100).toFixed(1)}%</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-success mb-4">
                            <i class="fas fa-star me-2"></i>
                            <strong>Pass 2 Complete!</strong> AI has reviewed and polished its own work for maximum quality.
                        </div>
                        
                        <!-- Three-column comparison -->
                        <div class="row">
                            <div class="col-md-4">
                                <h6><i class="fas fa-file-alt me-2"></i>Original:</h6>
                                <div class="border rounded p-3 bg-light mb-3" style="max-height: 150px; overflow-y: auto; font-size: 0.9rem;">
                                    ${currentContent}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h6><i class="fas fa-edit me-2 text-primary"></i>Pass 1:</h6>
                                <div class="border rounded p-3 bg-primary bg-opacity-10 mb-3" style="max-height: 150px; overflow-y: auto; font-size: 0.9rem;">
                                    ${firstPassResult}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h6><i class="fas fa-star me-2 text-warning"></i>Pass 2 - Final:</h6>
                                <div class="border rounded p-3 bg-warning bg-opacity-10 mb-3" style="max-height: 150px; overflow-y: auto; font-size: 0.9rem;">
                                    ${data.rewritten_text}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pass 2 Improvements -->
                        <div class="mb-4">
                            <h6><i class="fas fa-sparkles me-2"></i>Pass 2 Refinements:</h6>
                            <ul class="list-group list-group-flush">
                                ${data.improvements.map(improvement => `
                                    <li class="list-group-item border-0 px-0">
                                        <i class="fas fa-star text-warning me-2"></i>
                                        ${improvement}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                        
                        <!-- Final action buttons -->
                        <div class="text-center">
                            <button class="btn btn-success me-2" onclick="copyToClipboard('${data.rewritten_text.replace(/'/g, "\\'")}')">
                                <i class="fas fa-copy me-2"></i>Use Final Result
                            </button>
                            <button class="btn btn-outline-secondary me-2" onclick="analyzeContent('${data.rewritten_text.replace(/'/g, "\\'")}')">
                                <i class="fas fa-redo me-2"></i>Re-analyze Final
                            </button>
                            <button class="btn btn-outline-info" onclick="showComparisonModal('${currentContent.replace(/'/g, "\\'")}', '${firstPassResult.replace(/'/g, "\\'")}', '${data.rewritten_text.replace(/'/g, "\\'")}')">
                                <i class="fas fa-eye me-2"></i>Compare All Versions
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Replace the existing content with the new Pass 2 results
            resultsContainer.innerHTML = resultsContainer.innerHTML.replace(
                /<div class="card mt-4">[\s\S]*?<\/div>\s*<\/div>$/,
                html
            );
        }

        // Show comparison modal
        function showComparisonModal(original, pass1, pass2) {
            const modalHtml = `
                <div class="modal fade" id="comparisonModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-eye me-2"></i>Complete AI Process Comparison
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <h6 class="text-muted">Original Text</h6>
                                        <div class="border rounded p-3 bg-light" style="height: 300px; overflow-y: auto;">
                                            ${original}
                                        </div>
                                        <div class="mt-2 text-center">
                                            <small class="text-muted">${original.split(' ').length} words</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <h6 class="text-primary">Pass 1 Result</h6>
                                        <div class="border rounded p-3 bg-primary bg-opacity-10" style="height: 300px; overflow-y: auto;">
                                            ${pass1}
                                        </div>
                                        <div class="mt-2 text-center">
                                            <small class="text-muted">${pass1.split(' ').length} words</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <h6 class="text-warning">Pass 2 Final</h6>
                                        <div class="border rounded p-3 bg-warning bg-opacity-10" style="height: 300px; overflow-y: auto;">
                                            ${pass2}
                                        </div>
                                        <div class="mt-2 text-center">
                                            <small class="text-muted">${pass2.split(' ').length} words</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-success" onclick="copyToClipboard('${pass2.replace(/'/g, "\\'")}'); bootstrap.Modal.getInstance(document.getElementById('comparisonModal')).hide();">
                                    <i class="fas fa-copy me-2"></i>Copy Final Result
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('comparisonModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add new modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('comparisonModal'));
            modal.show();
        }

        // Modern helper functions with better, lighter color schemes
        function generateModernReadabilityCard(title, value, description, icon, colorClass) {
            const bgGradient = getReadabilityCardGradient(colorClass);
            return `
                <div class="col-6 mb-2">
                    <div class="text-center p-3 rounded-3" style="background: ${bgGradient}; border: 1px solid rgba(255,255,255,0.2); color: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div class="d-flex align-items-center justify-content-center mb-1">
                            <i class="${icon} me-2"></i>
                            <strong>${(value || 0).toFixed(1)}</strong>
                        </div>
                        <div class="small fw-medium" style="font-size: 0.75rem; line-height: 1.2;">
                            ${title}
                        </div>
                        <div class="small opacity-75" style="font-size: 0.65rem;">
                            ${description}
                        </div>
                    </div>
                </div>
            `;
        }

        function getReadabilityCardGradient(colorClass) {
            if (colorClass.includes('success')) return 'linear-gradient(135deg, #10b981, #059669)';
            if (colorClass.includes('warning')) return 'linear-gradient(135deg, #f59e0b, #d97706)';
            return 'linear-gradient(135deg, #ef4444, #dc2626)';
        }

        function getModernPassiveVoiceGradient(percentage) {
            if (percentage <= 10) return 'linear-gradient(90deg, #10b981, #059669)';
            if (percentage <= 15) return 'linear-gradient(90deg, #f59e0b, #d97706)';
            return 'linear-gradient(90deg, #ef4444, #dc2626)';
        }

        function getModernSentenceLengthGradient(length) {
            if (length >= 15 && length <= 20) return 'linear-gradient(90deg, #10b981, #059669)';
            if (length <= 25) return 'linear-gradient(90deg, #f59e0b, #d97706)';
            return 'linear-gradient(90deg, #ef4444, #dc2626)';
        }

        function getModernComplexWordsGradient(percentage) {
            if (percentage <= 15) return 'linear-gradient(90deg, #10b981, #059669)';
            if (percentage <= 25) return 'linear-gradient(90deg, #f59e0b, #d97706)';
            return 'linear-gradient(90deg, #ef4444, #dc2626)';
        }

        function generateModernSmartRecommendations(analysis) {
            const recommendations = [];
            const stats = analysis.statistics;
            
            // Grade level recommendations
            if (analysis.technical_writing_metrics?.estimated_grade_level > 12) {
                recommendations.push({
                    icon: 'fas fa-arrow-down',
                    text: 'Simplify sentences to lower grade level',
                    priority: 'high',
                    color: '#ef4444'
                });
            }
            
            // Passive voice recommendations
            if (stats.passive_voice_percentage > 15) {
                recommendations.push({
                    icon: 'fas fa-exchange-alt',
                    text: 'Reduce passive voice usage',
                    priority: 'medium',
                    color: '#f59e0b'
                });
            }
            
            // Sentence length recommendations
            if (stats.avg_sentence_length > 25) {
                recommendations.push({
                    icon: 'fas fa-cut',
                    text: 'Break up long sentences',
                    priority: 'high',
                    color: '#ef4444'
                });
            }
            
            // Complex words recommendations
            if (stats.complex_words_percentage > 20) {
                recommendations.push({
                    icon: 'fas fa-lightbulb',
                    text: 'Replace complex words with simpler alternatives',
                    priority: 'medium',
                    color: '#f59e0b'
                });
            }
            
            // Positive reinforcement
            if (recommendations.length === 0) {
                recommendations.push({
                    icon: 'fas fa-check-circle',
                    text: 'Excellent writing quality!',
                    priority: 'positive',
                    color: '#10b981'
                });
            }
            
            // Limit to top 3 recommendations
            return recommendations.slice(0, 3).map(rec => `
                <div class="d-flex align-items-center mb-3 p-3 rounded-3" style="background: rgba(255,255,255,0.9); border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <div class="me-3 d-flex align-items-center justify-content-center rounded-circle" style="width: 32px; height: 32px; background: linear-gradient(135deg, ${rec.color}20, ${rec.color}30); border: 1px solid ${rec.color}40;">
                        <i class="${rec.icon}" style="color: ${rec.color}; font-size: 0.9rem;"></i>
                    </div>
                    <span class="fw-medium" style="color: #374151; font-size: 0.9rem;">${rec.text}</span>
                </div>
            `).join('');
        }

        // Initialize tooltips
        document.addEventListener('DOMContentLoaded', function() {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });

        // Essential insight functions that were missing
        function getGradeLevelInsight(gradeLevel, meetsTarget) {
            if (!gradeLevel) return "Unable to calculate grade level";
            if (meetsTarget) return "Perfect for technical documentation readers";
            if (gradeLevel < 9) return "May be too simple for technical audience";
            if (gradeLevel > 15) return "Consider simplifying for broader accessibility";
            return "Slightly outside optimal range for technical docs";
        }

        function getPassiveVoiceInsight(percentage) {
            if (percentage <= 5) return "Excellent - very active writing";
            if (percentage <= 10) return "Good - mostly active voice";
            if (percentage <= 15) return "Acceptable - within recommended range";
            return "Consider converting to active voice";
        }

        function getSentenceLengthInsight(length) {
            if (length <= 15) return "Great - concise and clear";
            if (length <= 20) return "Perfect - optimal readability";
            if (length <= 25) return "Good - still readable";
            return "Consider breaking into shorter sentences";
        }

        function getComplexWordsInsight(percentage) {
            if (percentage <= 10) return "Excellent - very accessible";
            if (percentage <= 15) return "Good - appropriate complexity";
            if (percentage <= 20) return "Acceptable for technical content";
            return "Consider simpler alternatives";
        }

        // Essential color helper functions that were missing
        function getFleschColor(score) {
            if (score >= 60) return 'text-success';
            if (score >= 30) return 'text-warning';
            return 'text-danger';
        }

        function getFogColor(score) {
            if (score <= 12) return 'text-success';
            if (score <= 16) return 'text-warning';
            return 'text-danger';
        }

        function getGradeColor(score) {
            if (score >= 9 && score <= 11) return 'text-success';
            if (score >= 8 && score <= 13) return 'text-warning';
            return 'text-danger';
        }

        function getPassiveVoiceColor(percentage) {
            if (percentage <= 10) return 'bg-success';
            if (percentage <= 15) return 'bg-warning';
            return 'bg-danger';
        }

        function getSentenceLengthColor(length) {
            if (length >= 15 && length <= 20) return 'bg-success';
            if (length <= 25) return 'bg-warning';
            return 'bg-danger';
        }

        function getComplexWordsColor(percentage) {
            if (percentage <= 15) return 'bg-success';
            if (percentage <= 25) return 'bg-warning';
            return 'bg-danger';
        }
    </script>

    <!-- Help Modal for Metrics Explanation -->
    <div class="modal fade" id="metricsHelpModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-info-circle me-2"></i>Understanding Writing Metrics
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-graduation-cap me-2 text-primary"></i>Grade Level</h6>
                            <p class="small text-muted">Indicates the school grade level needed to understand your text. For technical documentation, aim for 9-11th grade.</p>
                            
                            <h6><i class="fas fa-book-open me-2 text-success"></i>Flesch Reading Ease</h6>
                            <p class="small text-muted">Scale of 0-100. Higher scores mean easier to read. 60+ is good for technical content.</p>
                            
                            <h6><i class="fas fa-tachometer-alt me-2 text-warning"></i>Gunning Fog Index</h6>
                            <p class="small text-muted">Years of formal education needed to understand text. Below 12 is recommended.</p>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-exchange-alt me-2 text-info"></i>Passive Voice</h6>
                            <p class="small text-muted">Percentage of sentences using passive voice. Keep under 15% for active, engaging writing.</p>
                            
                            <h6><i class="fas fa-text-width me-2 text-secondary"></i>Sentence Length</h6>
                            <p class="small text-muted">Average words per sentence. Aim for 15-20 words for optimal readability.</p>
                            
                            <h6><i class="fas fa-brain me-2 text-dark"></i>Complex Words</h6>
                            <p class="small text-muted">Words with 3+ syllables. Lower percentages improve accessibility.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% block extra_js %}{% endblock %}
</body>
</html> 